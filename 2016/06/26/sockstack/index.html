<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>sockstack | Hexo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="运维自动化之SaltStack简介SaltStack是用python语言写的，提供了API、支持多种操作系统（所有类Unix系统都默认安装Python），windows只能安装Minion端程序。
官网
中国SaltStack用户组
SaltStack 三大功能：
远程执行
配置管理（状态、很难回滚）
云管理


运维三板斧：监控、执行、配置管理

类似软件：Puppet(ruby)、Ansibl">
<meta property="og:type" content="article">
<meta property="og:title" content="sockstack">
<meta property="og:url" content="http://aresona.github.io/2016/06/26/sockstack/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="运维自动化之SaltStack简介SaltStack是用python语言写的，提供了API、支持多种操作系统（所有类Unix系统都默认安装Python），windows只能安装Minion端程序。
官网
中国SaltStack用户组
SaltStack 三大功能：
远程执行
配置管理（状态、很难回滚）
云管理


运维三板斧：监控、执行、配置管理

类似软件：Puppet(ruby)、Ansibl">
<meta property="og:image" content="https://www.unixhot.com/uploads/article/20151027/055f24981e25860e08942d7f0aa9d0ab.png">
<meta property="og:updated_time" content="2016-07-03T10:38:41.245Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="sockstack">
<meta name="twitter:description" content="运维自动化之SaltStack简介SaltStack是用python语言写的，提供了API、支持多种操作系统（所有类Unix系统都默认安装Python），windows只能安装Minion端程序。
官网
中国SaltStack用户组
SaltStack 三大功能：
远程执行
配置管理（状态、很难回滚）
云管理


运维三板斧：监控、执行、配置管理

类似软件：Puppet(ruby)、Ansibl">
<meta name="twitter:image" content="https://www.unixhot.com/uploads/article/20151027/055f24981e25860e08942d7f0aa9d0ab.png">
    

    
        <link rel="alternate" href="/" title="Hexo" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/vendor/open-sans/styles.css">
    <link rel="stylesheet" href="/vendor/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/vendor/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/vendor/lightgallery/css/lightgallery.min.css">
    
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">Hexo</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/avatar.png" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/avatar.png" />
            <h2 id="name">PPOffice</h2>
            <h3 id="title">Web Developer &amp; Designer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Harbin, China</span>
            <a id="follow" target="_blank" href="https://github.com/ppoffice/">FOLLOW</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                3
                <span>posts</span>
            </div>
            <div class="article-info-block">
                1
                <span>tag</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="http://github.com/ppoffice/hexo-theme-icarus" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="twitter" class=tooltip>
                            <i class="fa fa-twitter"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="facebook" class=tooltip>
                            <i class="fa fa-facebook"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="dribbble" class=tooltip>
                            <i class="fa fa-dribbble"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="rss" class=tooltip>
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main"><article id="post-sockstack" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
            sockstack
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2016/06/26/sockstack/">
            <time datetime="2016-06-26T09:43:18.000Z" itemprop="datePublished">2016-06-26</time>
        </a>
    </div>


                        
                        
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <h1 id="运维自动化之SaltStack"><a href="#运维自动化之SaltStack" class="headerlink" title="运维自动化之SaltStack"></a>运维自动化之SaltStack</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>SaltStack是用python语言写的，提供了API、支持多种操作系统（所有类Unix系统都默认安装Python），windows只能安装Minion端程序。</p>
<p><a href="https://saltstack.com/" target="_blank" rel="external">官网</a></p>
<p><a href="http://www.saltstack.cn" target="_blank" rel="external">中国SaltStack用户组</a></p>
<h3 id="SaltStack-三大功能："><a href="#SaltStack-三大功能：" class="headerlink" title="SaltStack 三大功能："></a>SaltStack 三大功能：</h3><ul>
<li>远程执行</li>
<li>配置管理（状态、很难回滚）</li>
<li>云管理</li>
</ul>
<blockquote>
<p>运维三板斧：监控、执行、配置管理</p>
</blockquote>
<p>类似软件：Puppet(ruby)、Ansible（python）</p>
<a id="more"></a>
<h3 id="SaltStack-四种运行方式"><a href="#SaltStack-四种运行方式" class="headerlink" title="SaltStack 四种运行方式"></a>SaltStack 四种运行方式</h3><ul>
<li>Local</li>
<li>Master/Minion（传统C/S架构）</li>
<li>Syndic（对应于zabbix的proxy)</li>
<li>Salt SSH</li>
</ul>
<blockquote>
<p>由于C/S模式需要在每台客户端机器上安装Salt-Minion,很多人会觉得麻烦,但是最佳的体验就是装一个Minion。</p>
</blockquote>
<h3 id="典型案例"><a href="#典型案例" class="headerlink" title="典型案例"></a>典型案例</h3><p>阿里大数据部门、360的远程执行</p>
<h2 id="QUICK-START"><a href="#QUICK-START" class="headerlink" title="QUICK START"></a>QUICK START</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ol>
<li>通过epel源安装</li>
<li>通过saltstack自己的仓库安装<pre>
yum install https://repo.saltstack.com/yum/redhat/salt-repo-latest-1.el7.noarch.rpm -y
</pre>

</li>
</ol>
<h4 id="Master端"><a href="#Master端" class="headerlink" title="Master端"></a>Master端</h4><pre>
yum install salt-master salt-minion -y
</pre>

<h4 id="Minion端"><a href="#Minion端" class="headerlink" title="Minion端"></a>Minion端</h4><pre>
yum install salt-minion -y
</pre>

<h4 id="windows下Minion安装"><a href="#windows下Minion安装" class="headerlink" title="windows下Minion安装"></a>windows下Minion安装</h4><pre>
Salt-Minion-2016.3.1-AMD64-Setup.exe /S /master=yoursaltmaster /minion-name=yourminionname
</pre>

<h3 id="配置及启动"><a href="#配置及启动" class="headerlink" title="配置及启动"></a>配置及启动</h3><h4 id="启动salt-master"><a href="#启动salt-master" class="headerlink" title="启动salt-master"></a>启动salt-master</h4><pre>
systemctl start salt-master
</pre>

<h4 id="配置并启动minion"><a href="#配置并启动minion" class="headerlink" title="配置并启动minion"></a>配置并启动minion</h4><pre>
sed -i 's/# master: salt/master: 192.168.56.11/' /etc/salt/minion
systemctl start salt-minion
</pre>
另外一个重要的参数就是id,每个minion都有一个单独的ID，它也放在     `/etc/salt` 目录下，如果不改的话，默认就是主机名
<pre>
[root@linux-node2 salt]# cat minion_id 
linux-node2.example.com
</pre>

<blockquote>
<p>这个ID不建议改，如果要改的话，要先把这个文件删除了。因为master会首先读这个文件，生产中可以用主机名，id可以不配，如果不配，它就会用主机名。</p>
</blockquote>
<h3 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h3><p>SaltStack是通过AES来加密的，所以一般不需要关注安全性问题，一般Minion启动的时候就会在/etc/salt下建立一个pki的目录，生成密钥对并把里面的公钥发给Master端。</p>
<pre>
[root@linux-node2 salt]# tree pki
pki
├── master
└── minion
    ├── minion.pem        私钥
    └── minion.pub        公钥
[root@linux-node1 salt]# tree pki/
pki/
├── master
│   ├── master.pem        Master私钥
│   ├── master.pub        Master公钥
│   ├── minions
│   ├── minions_autosign
│   ├── minions_denied
│   ├── minions_pre
│   │   ├── linux-node1.example.com        Minion发过来的两个私钥
│   │   └── linux-node2.example.com        默认会使用Minion_ID来做私钥的名称
│   └── minions_rejected
└── minion
    ├── minion.pem        Minion私钥
    └── minion.pub        Minion公钥
[root@linux-node1 salt]# md5sum pki/master/minions_pre/linux-node2.example.com 
eed44ea7c9d65c7aeddd56dedcebd3df  pki/master/minions_pre/linux-node2.example.com
[root@linux-node2 salt]# md5sum pki/minion/minion.pub 
eed44ea7c9d65c7aeddd56dedcebd3df  pki/minion/minion.pub
</pre>

<h4 id="列出所有keys"><a href="#列出所有keys" class="headerlink" title="列出所有keys"></a>列出所有keys</h4><pre>
[root@linux-node1 salt]# salt-key 
Accepted Keys:
Denied Keys:
Unaccepted Keys:
linux-node1.example.com
linux-node2.example.com
Rejected Keys:
</pre>
#### Master端同意所有申请管理的Minion端keys
<pre>
salt-key -a linux-node1.example.com
salt-key -a linux-node*
salt-key -A
[root@linux-node1 salt]# tree pki/
pki/
├── master
│   ├── master.pem
│   ├── master.pub
│   ├── minions
│   │   ├── linux-node1.example.com        ## Master同意
│   │   └── linux-node2.example.com
│   ├── minions_autosign
│   ├── minions_denied
│   ├── minions_pre
│   └── minions_rejected
└── minion
    ├── minion_master.pub        ## 这个是Master的公钥（认证后Master端会把自己的公钥发给Minion端）
    ├── minion.pem
    └── minion.pub
</pre>

<blockquote>
<p>认证的过程就是公钥交换的过程，改完ID后所有的认证就得重新来做一遍</p>
</blockquote>
<h3 id="ID的设置"><a href="#ID的设置" class="headerlink" title="ID的设置"></a>ID的设置</h3><p>ID设置有两种方式，一种是主机名，另外一种是通过IP地址，这时就需要看业务了，如果业务不确定就使用IP地址，如果业务确定就用主机名（idc01-bj-product-node1.shop.com）,DNS解析主机名不支持下滑线</p>
<h3 id="远程执行"><a href="#远程执行" class="headerlink" title="远程执行"></a>远程执行</h3><pre><code>salt &apos;*&apos; test.ping        ## 引起来是因为 * 在shell下也是有意义的
</code></pre><blockquote>
<p>test是一个模块，ping是这个模块下面的一个方法，它是python的标准；这个ping不是ICMP的ping，它是saltmaster和minion之间的一个通信，用的也不是ICMP的协议</p>
</blockquote>
<pre><code>salt &quot;linux-node1.example.com&quot; cmd.run &apos;w&apos;        ## 命令一般也要引起来，方便传参
</code></pre><p>操作实例：</p>
<pre><code>[root@linux-node1 salt]# salt &apos;*&apos; cmd.run &apos;mkdir hehe&apos;
linux-node2.example.com:
linux-node1.example.com:
[root@linux-node1 salt]# salt &apos;*&apos; cmd.run &apos;ls -l&apos;
linux-node2.example.com:
    total 4
    -rw-------. 1 root root 1175 May 20 06:37 anaconda-ks.cfg
    drwxr-xr-x  2 root root    6 Jun 25 21:01 hehe
linux-node1.example.com:
    total 4
    -rw-------. 1 root root 1175 May 20 06:37 anaconda-ks.cfg
    drwxr-xr-x  2 root root    6 Jun 25 21:01 hehe
</code></pre><p>后面可以通过ACL来控制权限，它很危险，可以执行删除操作</p>
<h3 id="salt命令用法"><a href="#salt命令用法" class="headerlink" title="salt命令用法"></a>salt命令用法</h3><p>查询 <code>status.all_status</code> 模块函数的使用方法</p>
<pre><code>[root@linux-node1 salt]# salt &apos;linux-node1.example.com&apos; sys.doc status.all_status
status.all_status:

    Return a composite of all status data and info for this minion.
    Warning: There is a LOT here!

    CLI Example:

        salt &apos;*&apos; status.all_status
</code></pre><p>查看test模块的用法</p>
<pre><code>salt &apos;*&apos; sys.doc test
test.ping:

    Used to make sure the minion is up and responding. Not an ICMP ping.

    Returns ``True``.

    CLI Example:

        salt &apos;*&apos; test.ping
</code></pre><p><a href="http://arlen.blog.51cto.com/7175583/1424216" target="_blank" rel="external">其他用法</a></p>
<h3 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h3><p>Salt通过 <strong>状态模块</strong> 来识别状态，所以需要写一个关于状态的文件，它是一个YAML格式的文件，并且文件名后缀以 <code>.sls</code> 结尾。</p>
<p><a href="https://www.unixhot.com/docs/saltstack/index.html" target="_blank" rel="external">SaltStack官方镜像文档</a></p>
<h4 id="理解YAML"><a href="#理解YAML" class="headerlink" title="理解YAML"></a>理解YAML</h4><blockquote>
<p>YAML是”YAML Ain’t a Markup Language”（YAML不是一种置标语言）的递归缩写。它是类似于标准通用标记语言的子集XML的数据描述语言，语法比XML简单很多。因为它简单。</p>
</blockquote>
<h5 id="三个规则"><a href="#三个规则" class="headerlink" title="三个规则"></a>三个规则</h5><ol>
<li>缩进（代表层级关系，2个空格，并且不能使用TAB键，整个saltstack里面都不能用TAB键）</li>
<li>冒号（1. 跟缩进一起代理层级目录（以冒号结尾不用空格）；2. 分隔键值对[key: value],支持嵌套，冒号后面必须有一个空格）</li>
<li>短横线（它是一个列表，<code>-</code> 后面必须有空格）</li>
</ol>
<blockquote>
<p>saltstack配置文件也是YAML语法。</p>
</blockquote>
<h4 id="写一个状态文件"><a href="#写一个状态文件" class="headerlink" title="写一个状态文件"></a>写一个状态文件</h4><p>编辑Master配置文件</p>
<p><code>/etc/salt/master</code></p>
<p>它是一个环境的定义，可以定义不同的路径，把不同业务放在不同的路径下，</p>
<pre><code>file_roots:            配置项
  base:                配置base环境
    - /srv/salt        可以写多个，它是个列表,base环境的根路径 
</code></pre><blockquote>
<p>salt使用一个写进ZeroMQ的轻量文件服务把文件分发到Minion端，这个文件服务直接集成到master的后端，不需要专门的端口；</p>
<p>文件服务工作在传递给Master端的各种环境上，每一个环境可以有多个根目录(root directories)，一个基础环境需要放置 <code>top</code> 文件<br>base环境默认必须有，并且不能修改名字</p>
</blockquote>
<p>重启master</p>
<pre><code>systemctl restart salt-master
</code></pre><p>创建目录</p>
<pre><code>mkdir /srv/salt -p
cd /srv/salt
mkdir web
cd web
cat &gt;&gt; apache.sls &lt;&lt;EOF
apache-install:        ## 每一个ID就是一个配置项
  pkg.installed:    ## 这里面的模块可以是内置的状态模块，也可以是自定义的状态模块
    - names:
        - httpd
        - httpd-devel

apache-service:
  service.running:
    - name: httpd
    - enable: True
EOF
</code></pre><blockquote>
<p>一个Salt状态可以使用单个的SLS文件（一个SLS文件就定义了一个状态），或者使用一个文件夹。后者更加灵活方便。</p>
<p>apache-install是定义的ID，pkg是一个状态模块，模块分为执行模块和状态模块，installed是模块中定义的函数方法</p>
<p>salt有很多的模块，它们都放在 <code>/usr/lib/python2.7/site-packages/salt/modules</code> 下，而 <code>pkg.py</code> 是放在 <code>/usr/lib/python2.7/site-packages/salt/states</code> 目录下的，所以说它是一个状态模块；</p>
</blockquote>
<p>执行状态模块</p>
<pre>
salt '*' state.sls web.apache
</pre>

<blockquote>
<p><code>state</code> 是一个模块（/usr/lib/python2.7/site-packages/salt/modules/state.py），sls是它的一个方法，它的作用就是 <code>Execute the states in one or more SLS files</code> ，这些状态文件是放在环境下的，并且这些状态文件里面会调用state的状态模块（/usr/lib/python2.7/site-packages/salt/states）。</p>
<p>/var/cache/salt/minion是一个很重要的目录，一般master把文件发给minion并放在这个目录下,minion从上往下加载</p>
</blockquote>
<h4 id="遇到的错误"><a href="#遇到的错误" class="headerlink" title="遇到的错误"></a>遇到的错误</h4><pre>
Salt request timed out. The master is not responding. If this error persists after verifying the master is up, worker_threads may need to be increased.
</pre>

<h4 id="执行小技巧"><a href="#执行小技巧" class="headerlink" title="执行小技巧"></a>执行小技巧</h4><blockquote>
<p>已经有的是绿色，新完成的是浅绿色</p>
</blockquote>
<h4 id="通过-top-sls来有选择地执行状态文件"><a href="#通过-top-sls来有选择地执行状态文件" class="headerlink" title="通过 top.sls来有选择地执行状态文件"></a>通过 <code>top.sls</code>来有选择地执行状态文件</h4><p>top文件也是sls结尾，也是YAML格式。它放在base环境下，也就是这里的/srv/salt下</p>
<pre>
# The state system uses a "top" file to tell the minions what environment to
# use and what modules to use. The state_top file is defined relative to the
# root of the base environment as defined in "File Server settings" below.
# state_top: top.sls
</pre>

<pre><code>cat &gt; top.sls &lt;&lt;EOF
base:
  &apos;linux-node1.example.com&apos;:
    - web.apache
  &apos;linux-node2.example.com&apos;:
    - web.apache
EOF
</code></pre><h5 id="执行高级状态"><a href="#执行高级状态" class="headerlink" title="执行高级状态"></a>执行高级状态</h5><pre><code>[root@linux-node1 salt]# salt &apos;*&apos; state.highstate
linux-node2.example.com:
----------
          ID: apache-install
    Function: pkg.installed
        Name: httpd
      Result: True
     Comment: Package httpd is already installed
     Started: 23:26:29.845158
    Duration: 605.676 ms
     Changes:   
----------
          ID: apache-install
    Function: pkg.installed
        Name: httpd-devel
      Result: True
     Comment: Package httpd-devel is already installed
     Started: 23:26:30.450979
    Duration: 0.433 ms
     Changes:   
----------
          ID: apache-service
    Function: service.running
        Name: httpd
      Result: True
     Comment: The service httpd is already running
     Started: 23:26:30.451937
    Duration: 27.567 ms
     Changes:   

Summary for linux-node2.example.com
------------
Succeeded: 3
Failed:    0
------------
Total states run:     3
linux-node1.example.com:
----------
          ID: apache-install
    Function: pkg.installed
        Name: httpd
      Result: True
     Comment: Package httpd is already installed
     Started: 23:26:29.999055
    Duration: 608.856 ms
     Changes:   
----------
          ID: apache-install
    Function: pkg.installed
        Name: httpd-devel
      Result: True
     Comment: Package httpd-devel is already installed
     Started: 23:26:30.608080
    Duration: 0.51 ms
     Changes:   
----------
          ID: apache-service
    Function: service.running
        Name: httpd
      Result: True
     Comment: The service httpd is already running
     Started: 23:26:30.609121
    Duration: 35.008 ms
     Changes:   

Summary for linux-node1.example.com
------------
Succeeded: 3
Failed:    0
------------
Total states run:     3
</code></pre><blockquote>
<p>生产中不建议用<em> ,以后不能这样写命令，要先 `salt ‘</em>‘ state.highstate test=True` </p>
</blockquote>
<h2 id="SaltStack与ZeroMQ"><a href="#SaltStack与ZeroMQ" class="headerlink" title="SaltStack与ZeroMQ"></a>SaltStack与ZeroMQ</h2><p> 我们进行自动化运维大多数情况下，是我们的服务器数量已经远远超过人工SSH维护的范围，SaltStack可以支持数以千计，甚至更多的服务器。这些性能的提供主要来自于ZeroMQ，因为SaltStack底层是基于ZeroMQ进行高效的网络通信。ZMQ用于node与node间的通信，node可以是主机也可以是进程。</p>
<h3 id="ZeroMQ简介"><a href="#ZeroMQ简介" class="headerlink" title="ZeroMQ简介"></a>ZeroMQ简介</h3><p>  ZeroMQ（我们通常还会用ØMQ , 0MQ, zmq等来表示）是一个简单好用的传输层，像框架一样的一个套接字库，他使得Socket编程更加简单、简洁和性能更高。它还是一个消息处理队列库，可在多个线程、内核和主机盒之间弹性伸缩。<br>发布与订阅 ZeroMQ支持Publish/Subscribe，即发布与订阅模式，我们经常简称Pub/Sub。</p>
<p><img src="https://www.unixhot.com/uploads/article/20151027/055f24981e25860e08942d7f0aa9d0ab.png" alt=""></p>
<h4 id="发布与订阅模式（Publish-Subscribe）简称Pub-Sub"><a href="#发布与订阅模式（Publish-Subscribe）简称Pub-Sub" class="headerlink" title="发布与订阅模式（Publish/Subscribe）简称Pub/Sub"></a>发布与订阅模式（Publish/Subscribe）简称Pub/Sub</h4><p>所有的minion都会连到4505端口，而且是TCP的长连接</p>
<p>salt ‘*’ cmd.run ‘w’</p>
<h4 id="请求与响应模式"><a href="#请求与响应模式" class="headerlink" title="请求与响应模式"></a>请求与响应模式</h4><p>默认监听4506端口，返回结果的时候通过4506端口，</p>
<h4 id="显示进程标题"><a href="#显示进程标题" class="headerlink" title="显示进程标题"></a>显示进程标题</h4><pre>
yum install -y python-setproctitle
systemctl restart salt-master
ps -ef|grep salt-mast
</pre>

<p><a href="https://www.unixhot.com/article/15" target="_blank" rel="external">相关文章介绍</a></p>
<h2 id="SaltStack的数据系统"><a href="#SaltStack的数据系统" class="headerlink" title="SaltStack的数据系统"></a>SaltStack的数据系统</h2><p><a href="http://www.cnblogs.com/alexyang8/p/3445333.html" target="_blank" rel="external">SaltStack整体架构</a></p>
<p>saltstack有两种数据系统：</p>
<ul>
<li>Grains（谷粒）</li>
<li>Pillar（柱子）</li>
</ul>
<h3 id="Grains"><a href="#Grains" class="headerlink" title="Grains"></a>Grains</h3><p>Grains是静态数据，它是在Minion启动的时候收集的Minion本地的相关信息，如：操作系统版本，内核版本，ＣＰＵ，内存，硬盘，设备型号，机器序列号。它可以做资产管理，只要不重启它，它就会只收集一次，当重启的时候才会再次收集，启动完后就不会变了,它是一个key/value的东西。</p>
<p><strong>作用</strong>：</p>
<ul>
<li>资产管理、信息查询</li>
<li>用于目标选择（不同于ID的另外目标定义方法，操作系统等）</li>
<li>配置管理中使用</li>
</ul>
<h4 id="信息查询"><a href="#信息查询" class="headerlink" title="信息查询"></a>信息查询</h4><p>查看所有信息</p>
<pre>
salt 'linux-node1.example.com' grains.ls
salt 'linux-node1.example.com' grains.items
salt '*' grains.item os
salt '*' grains.item fqdn_ip4
</pre>

<h4 id="目标选择"><a href="#目标选择" class="headerlink" title="目标选择"></a>目标选择</h4><p>-G 参数</p>
<pre>
salt -G 'os:CentOS' test.ping
salt -G 'os:CentOS' cmd.run 'echo hehe'
</pre>

<p>可以给某一个minion自定义一个grains，然后再来找它，方法：<br>写配置文件，有两种办法来存放它</p>
<pre>
vim /etc/salt/minion
grains:
  roles: apache 
</pre>

<pre><code>systemctl restart salt-minion
</code></pre><pre> 
[root@linux-node1 salt]# salt '*' grains.item roles
linux-node2.example.com:
    ----------
    rolesode1.example.com:
    ----------
    roles:
[root@linux-node1 salt]# salt '*' grains.item roles
linux-node1.example.com:
    ----------
    roles:
linux-node2.example.com:
    ----------
    roles:
        apache:
</pre>

<h4 id="重启所有apache"><a href="#重启所有apache" class="headerlink" title="重启所有apache"></a>重启所有apache</h4><pre><code>salt -G &apos;roles:apache&apos; cmd.run &apos;systemctl restart httpd&apos;
</code></pre><blockquote>
<p>生产不建议放在minion配置文件里面，写在 <code>/etc/salt/grains</code> 里面，minion会自动来这找；并且上面这条命令中的roles:后面是没有空格的</p>
</blockquote>
<pre><code>vim /etc/salt/grains
cloud: openstack

salt &apos;*&apos; grains.item cloud
</code></pre><blockquote>
<p>加完之后必须重启，因为它是静态的。但不重启也有一个刷新的命令 <code>salt &#39;*&#39; saltutil.sync_grains</code> 无论上面两种方法写在哪都可以成功。</p>
</blockquote>
<h3 id="top-file中使用grains案例"><a href="#top-file中使用grains案例" class="headerlink" title="top file中使用grains案例"></a>top file中使用grains案例</h3><p>grains还可以用到top.sls文件里面</p>
<pre>
base:
  'linux-node1.example.com':
    - web.apache
  'roles:apache': 
    - match: grain 
    - web.apache
</pre>


<h3 id="配置管理的案例"><a href="#配置管理的案例" class="headerlink" title="配置管理的案例"></a>配置管理的案例</h3><pre><code>vim /srv/salt/web/apache.sls
</code></pre><blockquote>
<p>可以自己用python脚本来写一个grains，实现动态，这里说的动态是通过逻辑后产生的</p>
</blockquote>
<h4 id="用Python开发一个grains"><a href="#用Python开发一个grains" class="headerlink" title="用Python开发一个grains"></a>用Python开发一个grains</h4><p>写一个python脚本返回一个字典就可以了。</p>
<ul>
<li>放哪儿</li>
</ul>
<pre>
cd /srv/salt/
mkdir _grains
cd _grains
</pre>
* 写脚本

<pre>
vim my_grains.py
#!/usr/bin/env python
#-*- coding: utf-8 -*-

def my_grains():
    # 初始化一个grains字典
    grains = {}
    # 设置字典中的key/value
    grains['iaas'] = 'openstack'
    grains['edu'] = 'example'
    # 返回这个字典
    return grains
</pre>

<ul>
<li>把grains推送给minion<pre>
salt '*' saltutil.sync_grains
</pre>

</li>
</ul>
<blockquote>
<p>它会放在/var/cache/salt/minion/extmods/grains/my_grains.py</p>
</blockquote>
<ul>
<li>查看grains条目</li>
</ul>
<pre>
salt '*' grains.item iaas
</pre>

<h4 id="Grains优先级："><a href="#Grains优先级：" class="headerlink" title="Grains优先级："></a>Grains优先级：</h4><ol>
<li>系统自带</li>
<li>grains文件写的</li>
<li>minion配置文件写的</li>
<li>自己写的</li>
</ol>
<h3 id="Pillar"><a href="#Pillar" class="headerlink" title="Pillar"></a>Pillar</h3><h4 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h4><p>它也是数据系统，也是定义一个key/value，但是pillar数据是动态的，和minion启不启动没关系，它会给特定的minion指定特定的数据，跟top file很像。只有指定的minion自己能看到自己的数据。</p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><ul>
<li>查看pillar条目</li>
</ul>
<pre>
salt '*' pillar.items
</pre>

<ul>
<li>在master端开启pillar功能</li>
</ul>
<p>修改配置文件/etc/salt/master并重启master服务 </p>
<pre><code>pillar_opts: True
pillar_roots:
  base:
    - /srv/pillar
systemctl restart salt-master
</code></pre><ul>
<li>编辑相关配置文件</li>
</ul>
<p>编辑pillar的SLS文件</p>
<pre>
mkdir /srv/pillar
cd /srv/pillar
mkdir web
cd web
vim apache.sls

</pre>

<p>编辑topfile(pillar必须要写topfile,不像配置管理不用也可以)</p>
<pre>
base:
  'linux-node2.oldboyedu.com':
    - web.apache
salt '*' saltutil.refresh_pillar
salt '*' pillar.items apache
</pre>
效果如下：
<pre>
[root@linux-node1 web]# salt '*' pillar.items apache
linux-node1.oldboyedu.com:
    ----------
    apache:
linux-node2.oldboyedu.com:
    ----------
    apache:
        httpd
linux-node2.oldboyedu.com:
    ----------
    apache:
</pre>

<ul>
<li>修改上面的文件并熟悉一下层级的概念<br><pre><br>vim apache.sls<br>hehe:
salt ‘<em>‘ saltutil.refresh_pillar<br>salt ‘</em>‘ pillar.items hehe</pre></li>
</ul>
<h4 id="个人理解"><a href="#个人理解" class="headerlink" title="个人理解"></a>个人理解</h4><p>topfile.sls规定哪个客户端经过哪个pillar判断文件的扫描，而web.apache就是那个判断文件的具体逻辑实现。</p>
<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><p>目标选择</p>
<pre><code>salt -I &apos;apache:httpd&apos; test.ping
</code></pre><h3 id="Grains-VS-Pillar"><a href="#Grains-VS-Pillar" class="headerlink" title="Grains VS Pillar"></a>Grains VS Pillar</h3><p>grians的items（roles）下可以是一个值，也可以是多个值，但是pillar的items下面还可以有多个items，它是一个嵌套的东西 ，它是一个真正的python字典的格式。</p>
<table>
<thead>
<tr>
<th>Grains</th>
<th>类型</th>
<th>数据采集方式</th>
<th>应用场景</th>
<th>定义位置</th>
</tr>
</thead>
<tbody>
<tr>
<td>Grains</td>
<td>静态</td>
<td>minion启动时收集</td>
<td>数据查询、目标选择、配置管理</td>
<td>minion端</td>
</tr>
<tr>
<td>Pillar</td>
<td>动态</td>
<td>master自定义</td>
<td>目标选择、配置管理、敏感数据</td>
<td>存储    master端</td>
</tr>
</tbody>
</table>
<blockquote>
<p>尽管看上去差不多，但是它们是有本质区别的，pillar数据是存储在master端，缓存在minion端的，而grains数据是存储在minion端，缓存在master端。</p>
</blockquote>
<p>相关文章：</p>
<p><a href="http://ohmystack.com/articles/salt-2-grains-and-pillar/" target="_blank" rel="external">区别</a></p>
<p><a href="http://stackoverflow.com/questions/13115700/salt-stack-grains-vs-pillars" target="_blank" rel="external">stackoverflow</a></p>
<p>总体理解：</p>
<p>grains和pillar的目的都是为了给一个定义一个客户端，而grains会定义一些比较基础的属性，因为它是静态的，给每个客户端定义所有的属性没必要也不现实；而pillar可以根据需求来给每一个客户端定义不同的属性，而这个前提就是它首先能通过minion id和grians找到它要定义的那个客户端;所以pillar的设计就在于它要补充grains的不足性，其次才是关于静态、保密的那些常见区别。</p>
<table>
<thead>
<tr>
<th>Differences</th>
<th>Grains</th>
<th>Pillars</th>
</tr>
</thead>
<tbody>
<tr>
<td>This is info which…</td>
<td>… Minion knows about itself</td>
<td>… Minion asks Master about</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Distributed:</td>
<td>Yes (different per minion)</td>
<td>No (single version per master)</td>
</tr>
<tr>
<td>Centralized:</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Computed automatically:</td>
<td>Yes (preset/computed value)</td>
<td>No (only rendered from Jinja/YAML)</td>
</tr>
<tr>
<td>Assigned manually:</td>
<td>No (too elaborate)</td>
<td>Yes (Jinja/YAML sources)</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Conceptually intrinsic to…</td>
<td>… individual Minion node</td>
<td>… entire system managed by Master</td>
</tr>
<tr>
<td>Data under revision control:</td>
<td>No (computed values)</td>
<td>Yes (Jinja/YAML sources)</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>They define rather…</td>
<td><em>provided</em> resources</td>
<td><em>required</em> resources</td>
</tr>
<tr>
<td></td>
<td>(e.g. minion OS version)</td>
<td>(e.g. packages to install)</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="远程执行-1"><a href="#远程执行-1" class="headerlink" title="远程执行"></a>远程执行</h2><p>深入学习SaltStack远程执行</p>
<pre><code>salt &apos;*&apos; cmd.run &apos;w&apos;
</code></pre><p>命令：salt</p>
<p>目标： ‘*’（好多种方式指定）</p>
<p>模块：cmd.run   自带150+模块。可以自己写模块</p>
<p>返回：可以写入数据库里面，执行后结果返回，通过Returnners组件</p>
<h3 id="目标Targeting"><a href="#目标Targeting" class="headerlink" title="目标Targeting"></a>目标Targeting</h3><p>你要指定哪个或者哪些minion来执行后面的东西 ，怎么来定位？</p>
<p>两种定位的方法：</p>
<ol>
<li>和minion id有关的</li>
<li>和Minion_id无关的</li>
</ol>
<h4 id="与minion-id有关的"><a href="#与minion-id有关的" class="headerlink" title="与minion_id有关的"></a>与minion_id有关的</h4><ul>
<li><p>Minion id</p>
<pre><code>linux-node1.example.com
</code></pre></li>
<li><p>通配符</p>
<pre><code>*/linux-node*/linux-node[1|2].example.com/linux-node?.example.com)
</code></pre></li>
<li><p>列表</p>
<pre><code>salt -L &apos;linux-node1.example.com,linux-node2.example.com&apos; test.ping
</code></pre></li>
<li><p>正则表达式</p>
<pre><code>salt -E &apos;linux-(node1|node2)*&apos; test.ping|salt -E &apos;linux-(node1|node2).example.com&apos; test.ping）
</code></pre></li>
</ul>
<blockquote>
<p>所有匹配目标的方式都可以用在top file里面来指定目标 </p>
</blockquote>
<h4 id="与minion-id无关的"><a href="#与minion-id无关的" class="headerlink" title="与minion_id无关的"></a>与minion_id无关的</h4><p>主机名设置方案：</p>
<ol>
<li>IP地址</li>
<li>根据业务来进行设置</li>
</ol>
<pre>
redis-node1-redis03-idc03-soa.example.com
</pre>

<p>redis-node1  redis第一个节点</p>
<p>redis04   集群</p>
<p>idc04   机房</p>
<p>soa    业务线</p>
<h5 id="子网和IP地址"><a href="#子网和IP地址" class="headerlink" title="子网和IP地址"></a>子网和IP地址</h5><pre>
salt -S 192.168.56.11 test.ping
salt -S 192.168.56.0/24 test.ping
</pre>

<h5 id="NODE-GROUPS"><a href="#NODE-GROUPS" class="headerlink" title="NODE GROUPS"></a>NODE GROUPS</h5><pre>
vim /etc/salt/master
/nodegroup

nodegroups:
  web: 'L@linux-node1.example.com,linux-node2.example.com'
systemctl restart salt-master
salt -N web test.ping
</pre>

<h5 id="混合匹配"><a href="#混合匹配" class="headerlink" title="混合匹配"></a>混合匹配</h5><p><a href="https://www.unixhot.com/docs/saltstack/topics/targeting/compound.html" target="_blank" rel="external">官方文档</a></p>
<pre><code>salt -C &apos;* and not web-dc1-srv&apos; test.ping
</code></pre><h5 id="批处理"><a href="#批处理" class="headerlink" title="批处理"></a>批处理</h5><p>可以通过百分比来执行</p>
<h3 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h3><p>saltstack内置了丰富的模块来执行,每一个模块都是一个python文件，挑几个来学习</p>
<h4 id="NETWORK"><a href="#NETWORK" class="headerlink" title="NETWORK"></a>NETWORK</h4><pre><code>salt &apos;*&apos; network.active_tcp
salt &apos;*&apos; network.arp
</code></pre><h4 id="SERVICE"><a href="#SERVICE" class="headerlink" title="SERVICE"></a>SERVICE</h4><pre><code>salt &apos;*&apos; service.available sshd
salt &apos;*&apos; service.get_all
</code></pre><h4 id="CP"><a href="#CP" class="headerlink" title="CP"></a>CP</h4><pre><code>salt-cp &apos;*&apos; /etc/hosts /tmp/hehe
</code></pre><h4 id="STATE"><a href="#STATE" class="headerlink" title="STATE"></a>STATE</h4><pre><code>salt &apos;*&apos; state.show_top
salt &apos;*&apos; state.single pkg.installed name=lsof
</code></pre><h3 id="返回程序"><a href="#返回程序" class="headerlink" title="返回程序"></a>返回程序</h3><p>salt使用返回程序来实现把返回结果写到数据库里面(returnners)</p>
<h4 id="SALT-RETURNERS-MYSQL"><a href="#SALT-RETURNERS-MYSQL" class="headerlink" title="SALT.RETURNERS.MYSQL"></a>SALT.RETURNERS.MYSQL</h4><blockquote>
<p>Return data to mysql server</p>
</blockquote>
<p>这个返回数据是minion直接返回的(直接返回数据到数据库，而不经过master端，所有的minion要装python的MySQL 库</p>
<p>这里我们可以使用salt来安装</p>
<pre>
salt '*' state.single pkg.installed name=MySQL-python
yum install mariadb-server mariadb -y
systemctl start mariadb
</pre>

<pre>
mysql
CREATE DATABASE  `salt`
  DEFAULT CHARACTER SET utf8
  DEFAULT COLLATE utf8_general_ci;
USE `salt`;
CREATE TABLE `jids` (
  `jid` varchar(255) NOT NULL,
  `load` mediumtext NOT NULL,
  UNIQUE KEY `jid` (`jid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
CREATE INDEX jid ON jids(jid) USING BTREE;
CREATE TABLE `salt_returns` (
  `fun` varchar(50) NOT NULL,
  `jid` varchar(255) NOT NULL,
  `return` mediumtext NOT NULL,
  `id` varchar(255) NOT NULL,
  `success` varchar(10) NOT NULL,
  `full_ret` mediumtext NOT NULL,
  `alter_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  KEY `id` (`id`),
  KEY `jid` (`jid`),
  KEY `fun` (`fun`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
CREATE TABLE `salt_events` (
`id` BIGINT NOT NULL AUTO_INCREMENT,
`tag` varchar(255) NOT NULL,
`data` mediumtext NOT NULL,
`alter_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
`master_id` varchar(255) NOT NULL,
PRIMARY KEY (`id`),
KEY `tag` (`tag`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
grant all on salt.* to salt@'%' identified by 'salt@pw';
flush privileges;
mysql -h 192.168.56.11 -usalt -psalt@pw
</pre>

<p>修改minion配置文件</p>
<pre>
vim /etc/salt/minion
mysql.host: '192.168.56.11'
mysql.user: 'salt'
mysql.pass: 'salt@pw'
mysql.db: 'salt'
mysql.port: 3306
systemctl restart salt-minion
</pre>

<p>执行结果：</p>
<pre>
[root@linux-node1 salt]# salt '*' test.ping --return mysql
linux-node2.example.com:
    True
linux-node1.example.com:
    True
[root@linux-node1 salt]# mysql
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 8
Server version: 5.5.47-MariaDB MariaDB Server

Copyright (c) 2000, 2015, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]> use salt;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MariaDB [salt]> show tables;
+----------------+
| Tables_in_salt |
+----------------+
| jids           |
| salt_events    |
| salt_returns   |
+----------------+
3 rows in set (0.00 sec)

MariaDB [salt]> select * from salt_returns;
+-----------+----------------------+--------+---------------------------+---------+-------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+
| fun       | jid                  | return | id                        | success | full_ret                                                                                                                                              | alter_time          |
+-----------+----------------------+--------+---------------------------+---------+-------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+
| test.ping | 20160626025439671711 | true   | linux-node2.example.com | 1       | {"fun_args": [], "jid": "20160626025439671711", "return": true, "retcode": 0, "success": true, "fun": "test.ping", "id": "linux-node2.example.com"} | 2016-06-26 02:54:39 |
| test.ping | 20160626025439671711 | true   | linux-node1.example.com | 1       | {"fun_args": [], "jid": "20160626025439671711", "return": true, "retcode": 0, "success": true, "fun": "test.ping", "id": "linux-node1.example.com"} | 2016-06-26 02:54:39 |
+-----------+----------------------+--------+---------------------------+---------+-------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+
2 rows in set (0.00 sec)
</pre>

<h3 id="编写一个执行模块"><a href="#编写一个执行模块" class="headerlink" title="编写一个执行模块"></a>编写一个执行模块</h3><pre><code>vim /usr/lib/python2.7/site-packages/salt/modules/service.py
</code></pre><p>编写模块：</p>
<ol>
<li>放哪（cd /srv/salt/_modules）</li>
<li>命名（文件名就是模块名，如my_disk.py）</li>
</ol>
<pre>
[root@linux-node1 _modules]# cat my_disk.py 
#!/usr/bin/env python

def list():
  cmd = 'df -h'
  ret = __salt__['cmd.run'](cmd)
  return ret
</pre>

<p>刷新</p>
<pre><code>salt &apos;*&apos; saltutil.sync_modules
</code></pre><pre>
[root@linux-node2 ~]# tree /var/cache/salt/minion/
/var/cache/salt/minion/
├── accumulator
├── extmods
│   ├── grains
│   │   ├── my_grains.py
│   │   └── my_grains.pyc
│   └── modules
│       └── my_disk.py
├── files
│   └── base
│       ├── _grains
│       │   └── my_grains.py
│       ├── _modules
│       │   └── my_disk.py
│       ├── top.sls
│       └── web
│           └── apache.sls
├── highstate.cache.p
├── module_refresh
├── pkg_refresh
├── proc
└── sls.p

[root@linux-node1 _modules]# salt '*' my_disk.list
linux-node2.example.com:
    Filesystem      Size  Used Avail Use% Mounted on
    /dev/sda3       196G  2.1G  194G   2% /
    devtmpfs        480M     0  480M   0% /dev
    tmpfs           489M   12K  489M   1% /dev/shm
    tmpfs           489M  6.7M  483M   2% /run
    tmpfs           489M     0  489M   0% /sys/fs/cgroup
    /dev/sda1       497M  128M  370M  26% /boot
    tmpfs            98M     0   98M   0% /run/user/0
linux-node1.example.com:
    Filesystem      Size  Used Avail Use% Mounted on
    /dev/sda3       196G  2.3G  194G   2% /
    devtmpfs        480M     0  480M   0% /dev
    tmpfs           489M   40K  489M   1% /dev/shm
    tmpfs           489M  6.8M  483M   2% /run
    tmpfs           489M     0  489M   0% /sys/fs/cgroup
    /dev/sda1       497M  128M  370M  26% /boot
    tmpfs            98M     0   98M   0% /run/user/0
</pre>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://aresona.github.io/2016/06/26/sockstack/" data-id="cisxcjmmo000158md75u4lnfe" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://aresona.github.io/2016/06/26/sockstack/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://aresona.github.io/2016/06/26/sockstack/">Comments</a>
    

        </footer>
    </div>
    
        
<nav id="article-nav">
    
    
        <a href="/2016/06/22/zabbix2/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Older</strong>
            <div class="article-nav-title">zabbix2</div>
        </a>
    
</nav>


    
</article>


    
    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>

</section>
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">recent</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2016/06/26/sockstack/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2016/06/26/sockstack/" class="title">sockstack</a></p>
                            <p class="item-date"><time datetime="2016-06-26T09:43:18.000Z" itemprop="datePublished">2016-06-26</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2016/06/22/zabbix2/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2016/06/22/zabbix2/" class="title">zabbix2</a></p>
                            <p class="item-date"><time datetime="2016-06-22T14:05:17.000Z" itemprop="datePublished">2016-06-22</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2016/06/20/主机规范/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2016/06/20/主机规范/" class="title">主机规范</a></p>
                            <p class="item-date"><time datetime="2016-06-20T03:31:20.000Z" itemprop="datePublished">2016-06-20</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    
        
    <div class="widget-wrap">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">3</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tags</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/">blog</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/blog/" style="font-size: 10px;">blog</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">links</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2016 John Doe<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_config = function () {
        
            this.page.url = 'http://aresona.github.io/2016/06/26/sockstack/';
        
        this.page.identifier = 'sockstack';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'hexo-theme-icarus' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>



    
        <script src="/vendor/lightgallery/js/lightgallery.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-pager.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-hash.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-share.min.js"></script>
        <script src="/vendor/lightgallery/js/lg-video.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>