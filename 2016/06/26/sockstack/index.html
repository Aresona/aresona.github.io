<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="运维自动化之SaltStack简介SaltStack是用python语言写的，提供了API、支持多种操作系统（所有类Unix系统都默认安装Python），windows只能安装Minion端程序。">
<meta property="og:type" content="article">
<meta property="og:title" content="sockstack">
<meta property="og:url" content="http://aresona.github.io/2016/06/26/sockstack/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="运维自动化之SaltStack简介SaltStack是用python语言写的，提供了API、支持多种操作系统（所有类Unix系统都默认安装Python），windows只能安装Minion端程序。">
<meta property="og:image" content="https://www.unixhot.com/uploads/article/20151027/055f24981e25860e08942d7f0aa9d0ab.png">
<meta property="og:image" content="https://github.com/Aresona/edu-docs/blob/master/image/touxiang.jpg">
<meta property="og:updated_time" content="2016-06-26T09:46:14.154Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="sockstack">
<meta name="twitter:description" content="运维自动化之SaltStack简介SaltStack是用python语言写的，提供了API、支持多种操作系统（所有类Unix系统都默认安装Python），windows只能安装Minion端程序。">
<meta name="twitter:image" content="https://www.unixhot.com/uploads/article/20151027/055f24981e25860e08942d7f0aa9d0ab.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://aresona.github.io/2016/06/26/sockstack/"/>

  <title> sockstack | Hexo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Hexo</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                sockstack
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-06-26T17:43:18+08:00" content="2016-06-26">
              2016-06-26
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="运维自动化之SaltStack"><a href="#运维自动化之SaltStack" class="headerlink" title="运维自动化之SaltStack"></a>运维自动化之SaltStack</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>SaltStack是用python语言写的，提供了API、支持多种操作系统（所有类Unix系统都默认安装Python），windows只能安装Minion端程序。</p>
<a id="more"></a>
<p><a href="https://saltstack.com/" target="_blank" rel="external">官网</a></p>
<p><a href="http://www.saltstack.cn" target="_blank" rel="external">中国SaltStack用户组</a></p>
<h3 id="SaltStack-三大功能："><a href="#SaltStack-三大功能：" class="headerlink" title="SaltStack 三大功能："></a>SaltStack 三大功能：</h3><ul>
<li>远程执行</li>
<li>配置管理（状态、很难回滚）</li>
<li>云管理</li>
</ul>
<blockquote>
<p>运维三板斧：监控、执行、配置管理</p>
</blockquote>
<p>类似软件：Puppet(ruby)、Ansible（python）</p>
<h3 id="SaltStack-四种运行方式"><a href="#SaltStack-四种运行方式" class="headerlink" title="SaltStack 四种运行方式"></a>SaltStack 四种运行方式</h3><ul>
<li>Local</li>
<li>Master/Minion（传统C/S架构）</li>
<li>Syndic（对应于zabbix的proxy)</li>
<li>Salt SSH</li>
</ul>
<blockquote>
<p>由于C/S模式需要在每台客户端机器上安装Salt-Minion,很多人会觉得麻烦,但是最佳的体验就是装一个Minion。</p>
</blockquote>
<h3 id="典型案例"><a href="#典型案例" class="headerlink" title="典型案例"></a>典型案例</h3><p>阿里大数据部门、360的远程执行</p>
<h2 id="QUICK-START"><a href="#QUICK-START" class="headerlink" title="QUICK START"></a>QUICK START</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ol>
<li>通过epel源安装</li>
<li>通过saltstack自己的仓库安装<pre>
yum install https://repo.saltstack.com/yum/redhat/salt-repo-latest-1.el7.noarch.rpm -y
</pre>

</li>
</ol>
<h6 id="Master端"><a href="#Master端" class="headerlink" title="Master端"></a>Master端</h6><pre>
yum install salt-master salt-minion -y
</pre>

<h6 id="Minion端"><a href="#Minion端" class="headerlink" title="Minion端"></a>Minion端</h6><pre>
yum install salt-minion -y
</pre>

<h6 id="windows下Minion安装"><a href="#windows下Minion安装" class="headerlink" title="windows下Minion安装"></a>windows下Minion安装</h6><pre>
Salt-Minion-2016.3.1-AMD64-Setup.exe /S /master=yoursaltmaster /minion-name=yourminionname
</pre>

<h3 id="配置及启动"><a href="#配置及启动" class="headerlink" title="配置及启动"></a>配置及启动</h3><h6 id="启动salt-master"><a href="#启动salt-master" class="headerlink" title="启动salt-master"></a>启动salt-master</h6><pre>
systemctl start salt-master
</pre>

<h6 id="配置并启动minion"><a href="#配置并启动minion" class="headerlink" title="配置并启动minion"></a>配置并启动minion</h6><pre>
sed -i 's/# master: salt/master: 192.168.56.11/' /etc/salt/minion
systemctl start salt-minion
</pre>
另外一个重要的参数就是id,每个minion都有一个单独的ID，它也放在     `/etc/salt` 目录下，如果不改的话，默认就是主机名
<pre>
[root@linux-node2 salt]# cat minion_id 
linux-node2.example.com
</pre>

<blockquote>
<p>这个ID不建议改，如果要改的话，要先把这个文件删除了。因为master会首先读这个文件，生产中可以用主机名，id可以不配，如果不配，它就会用主机名。</p>
</blockquote>
<h3 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h3><p>SaltStack是通过AES来加密的，所以一般不需要关注安全性问题，一般Minion启动的时候就会在/etc/salt下建立一个pki的目录，生成密钥对并把里面的公钥发给Master端。</p>
<pre>
[root@linux-node2 salt]# tree pki
pki
├── master
└── minion
    ├── minion.pem        私钥
    └── minion.pub        公钥
[root@linux-node1 salt]# tree pki/
pki/
├── master
│   ├── master.pem        Master私钥
│   ├── master.pub        Master公钥
│   ├── minions
│   ├── minions_autosign
│   ├── minions_denied
│   ├── minions_pre
│   │   ├── linux-node1.example.com        Minion发过来的两个私钥
│   │   └── linux-node2.example.com        默认会使用Minion_ID来做私钥的名称
│   └── minions_rejected
└── minion
    ├── minion.pem        Minion私钥
    └── minion.pub        Minion公钥
[root@linux-node1 salt]# md5sum pki/master/minions_pre/linux-node2.example.com 
eed44ea7c9d65c7aeddd56dedcebd3df  pki/master/minions_pre/linux-node2.example.com
[root@linux-node2 salt]# md5sum pki/minion/minion.pub 
eed44ea7c9d65c7aeddd56dedcebd3df  pki/minion/minion.pub
</pre>

<h6 id="列出所有keys"><a href="#列出所有keys" class="headerlink" title="列出所有keys"></a>列出所有keys</h6><pre>
[root@linux-node1 salt]# salt-key 
Accepted Keys:
Denied Keys:
Unaccepted Keys:
linux-node1.example.com
linux-node2.example.com
Rejected Keys:
</pre>
###### Master端同意所有申请管理的Minion端keys
<pre>
salt-key -a linux-node1.example.com
salt-key -a linux-node*
salt-key -A
[root@linux-node1 salt]# tree pki/
pki/
├── master
│   ├── master.pem
│   ├── master.pub
│   ├── minions
│   │   ├── linux-node1.example.com        ## Master同意
│   │   └── linux-node2.example.com
│   ├── minions_autosign
│   ├── minions_denied
│   ├── minions_pre
│   └── minions_rejected
└── minion
    ├── minion_master.pub        ## 这个是Master的公钥（认证后Master端会把自己的公钥发给Minion端）
    ├── minion.pem
    └── minion.pub
</pre>

<blockquote>
<p>认证的过程就是公钥交换的过程，改完ID后所有的认证就得重新来做一遍</p>
</blockquote>
<h3 id="ID的设置"><a href="#ID的设置" class="headerlink" title="ID的设置"></a>ID的设置</h3><p>ID设置有两种方式，一种是主机名，另外一种是通过IP地址，这时就需要看业务了，如果业务不确定就使用IP地址，如果业务确定就用主机名（idc01-bj-product-node1.shop.com）,DNS解析主机名不支持下滑线</p>
<h3 id="远程执行"><a href="#远程执行" class="headerlink" title="远程执行"></a>远程执行</h3><pre><code>salt &apos;*&apos; test.ping        ## 引起来是因为 * 在shell下也是有意义的
</code></pre><blockquote>
<p>test是一个模块，ping是这个模块下面的一个方法，它是python的标准；这个ping不是ICMP的ping，它是saltmaster和minion之间的一个通信，用的也不是ICMP的协议</p>
</blockquote>
<pre><code>salt &quot;linux-node1.example.com&quot; cmd.run &apos;w&apos;        ## 命令一般也要引起来，方便传参
</code></pre><p>操作实例：</p>
<pre><code>[root@linux-node1 salt]# salt &apos;*&apos; cmd.run &apos;mkdir hehe&apos;
linux-node2.example.com:
linux-node1.example.com:
[root@linux-node1 salt]# salt &apos;*&apos; cmd.run &apos;ls -l&apos;
linux-node2.example.com:
    total 4
    -rw-------. 1 root root 1175 May 20 06:37 anaconda-ks.cfg
    drwxr-xr-x  2 root root    6 Jun 25 21:01 hehe
linux-node1.example.com:
    total 4
    -rw-------. 1 root root 1175 May 20 06:37 anaconda-ks.cfg
    drwxr-xr-x  2 root root    6 Jun 25 21:01 hehe
</code></pre><p>后面可以通过ACL来控制权限，它很危险，可以执行删除操作</p>
<h3 id="salt命令用法"><a href="#salt命令用法" class="headerlink" title="salt命令用法"></a>salt命令用法</h3><p>查询 <code>status.all_status</code> 模块函数的使用方法</p>
<pre><code>[root@linux-node1 salt]# salt &apos;linux-node1.example.com&apos; sys.doc status.all_status
status.all_status:

    Return a composite of all status data and info for this minion.
    Warning: There is a LOT here!

    CLI Example:

        salt &apos;*&apos; status.all_status
</code></pre><p>查看test模块的用法</p>
<pre><code>salt &apos;*&apos; sys.doc test
test.ping:

    Used to make sure the minion is up and responding. Not an ICMP ping.

    Returns ``True``.

    CLI Example:

        salt &apos;*&apos; test.ping
</code></pre><p><a href="http://arlen.blog.51cto.com/7175583/1424216" target="_blank" rel="external">其他用法</a></p>
<h3 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h3><p>Salt通过 <strong>状态模块</strong> 来识别状态，所以需要写一个关于状态的文件，它是一个YAML格式的文件，并且文件名后缀以 <code>.sls</code> 结尾。</p>
<p><a href="https://www.unixhot.com/docs/saltstack/index.html" target="_blank" rel="external">SaltStack官方镜像文档</a></p>
<h5 id="理解YAML"><a href="#理解YAML" class="headerlink" title="理解YAML"></a>理解YAML</h5><blockquote>
<p>YAML是”YAML Ain’t a Markup Language”（YAML不是一种置标语言）的递归缩写。它是类似于标准通用标记语言的子集XML的数据描述语言，语法比XML简单很多。因为它简单。</p>
</blockquote>
<h6 id="三个规则"><a href="#三个规则" class="headerlink" title="三个规则"></a>三个规则</h6><ol>
<li>缩进（代表层级关系，2个空格，并且不能使用TAB键，整个saltstack里面都不能用TAB键）</li>
<li>冒号（1. 跟缩进一起代理层级目录（以冒号结尾不用空格）；2. 分隔键值对[key: value],支持嵌套，冒号后面必须有一个空格）</li>
<li>短横线（它是一个列表，<code>-</code> 后面必须有空格）</li>
</ol>
<blockquote>
<p>saltstack配置文件也是YAML语法。</p>
</blockquote>
<h4 id="写一个状态文件"><a href="#写一个状态文件" class="headerlink" title="写一个状态文件"></a>写一个状态文件</h4><p>编辑Master配置文件</p>
<p><code>/etc/salt/master</code></p>
<p>它是一个环境的定义，可以定义不同的路径，把不同业务放在不同的路径下，</p>
<pre><code>file_roots:            配置项
  base:                配置base环境
    - /srv/salt        可以写多个，它是个列表,base环境的根路径 
</code></pre><blockquote>
<p>salt使用一个写进ZeroMQ的轻量文件服务把文件分发到Minion端，这个文件服务直接集成到master的后端，不需要专门的端口；</p>
<p>文件服务工作在传递给Master端的各种环境上，每一个环境可以有多个根目录(root directories)，一个基础环境需要放置 <code>top</code> 文件<br>base环境默认必须有，并且不能修改名字</p>
</blockquote>
<p>重启master</p>
<pre><code>systemctl restart salt-master
</code></pre><p>创建目录</p>
<pre><code>mkdir /srv/salt -p
cd /srv/salt
mkdir web
cd web
cat &gt;&gt; apache.sls &lt;&lt;EOF
apache-install:        ## 每一个ID就是一个配置项
  pkg.installed:    ## 这里面的模块可以是内置的状态模块，也可以是自定义的状态模块
    - names:
        - httpd
        - httpd-devel

apache-service:
  service.running:
    - name: httpd
    - enable: True
EOF
</code></pre><blockquote>
<p>一个Salt状态可以使用单个的SLS文件（一个SLS文件就定义了一个状态），或者使用一个文件夹。后者更加灵活方便。</p>
<p>apache-install是定义的ID，pkg是一个状态模块，模块分为执行模块和状态模块，installed是模块中定义的函数方法</p>
<p>salt有很多的模块，它们都放在 <code>/usr/lib/python2.7/site-packages/salt/modules</code> 下，而 <code>pkg.py</code> 是放在 <code>/usr/lib/python2.7/site-packages/salt/states</code> 目录下的，所以说它是一个状态模块；</p>
</blockquote>
<p>执行状态模块</p>
<pre>
salt '*' state.sls web.apache
</pre>

<blockquote>
<p><code>state</code> 是一个模块（/usr/lib/python2.7/site-packages/salt/modules/state.py），sls是它的一个方法，它的作用就是 <code>Execute the states in one or more SLS files</code> ，这些状态文件是放在环境下的，并且这些状态文件里面会调用state的状态模块（/usr/lib/python2.7/site-packages/salt/states）。</p>
<p>/var/cache/salt/minion是一个很重要的目录，一般master把文件发给minion并放在这个目录下,minion从上往下加载</p>
</blockquote>
<h6 id="遇到的错误"><a href="#遇到的错误" class="headerlink" title="遇到的错误"></a>遇到的错误</h6><pre>
Salt request timed out. The master is not responding. If this error persists after verifying the master is up, worker_threads may need to be increased.
</pre>

<h6 id="执行小技巧"><a href="#执行小技巧" class="headerlink" title="执行小技巧"></a>执行小技巧</h6><blockquote>
<p>已经有的是绿色，新完成的是浅绿色</p>
</blockquote>
<h4 id="通过-top-sls来有选择地执行状态文件"><a href="#通过-top-sls来有选择地执行状态文件" class="headerlink" title="通过 top.sls来有选择地执行状态文件"></a>通过 <code>top.sls</code>来有选择地执行状态文件</h4><p>top文件也是sls结尾，也是YAML格式。它放在base环境下，也就是这里的/srv/salt下</p>
<pre>
# The state system uses a "top" file to tell the minions what environment to
# use and what modules to use. The state_top file is defined relative to the
# root of the base environment as defined in "File Server settings" below.
# state_top: top.sls
</pre>

<pre><code>cat &gt; top.sls &lt;&lt;EOF
base:
  &apos;linux-node1.example.com&apos;:
    - web.apache
  &apos;linux-node2.example.com&apos;:
    - web.apache
EOF
</code></pre><h5 id="执行高级状态"><a href="#执行高级状态" class="headerlink" title="执行高级状态"></a>执行高级状态</h5><pre><code>[root@linux-node1 salt]# salt &apos;*&apos; state.highstate
linux-node2.example.com:
----------
          ID: apache-install
    Function: pkg.installed
        Name: httpd
      Result: True
     Comment: Package httpd is already installed
     Started: 23:26:29.845158
    Duration: 605.676 ms
     Changes:   
----------
          ID: apache-install
    Function: pkg.installed
        Name: httpd-devel
      Result: True
     Comment: Package httpd-devel is already installed
     Started: 23:26:30.450979
    Duration: 0.433 ms
     Changes:   
----------
          ID: apache-service
    Function: service.running
        Name: httpd
      Result: True
     Comment: The service httpd is already running
     Started: 23:26:30.451937
    Duration: 27.567 ms
     Changes:   

Summary for linux-node2.example.com
------------
Succeeded: 3
Failed:    0
------------
Total states run:     3
linux-node1.example.com:
----------
          ID: apache-install
    Function: pkg.installed
        Name: httpd
      Result: True
     Comment: Package httpd is already installed
     Started: 23:26:29.999055
    Duration: 608.856 ms
     Changes:   
----------
          ID: apache-install
    Function: pkg.installed
        Name: httpd-devel
      Result: True
     Comment: Package httpd-devel is already installed
     Started: 23:26:30.608080
    Duration: 0.51 ms
     Changes:   
----------
          ID: apache-service
    Function: service.running
        Name: httpd
      Result: True
     Comment: The service httpd is already running
     Started: 23:26:30.609121
    Duration: 35.008 ms
     Changes:   

Summary for linux-node1.example.com
------------
Succeeded: 3
Failed:    0
------------
Total states run:     3
</code></pre><blockquote>
<p>生产中不建议用<em> ,以后不能这样写命令，要先 `salt ‘</em>‘ state.highstate test=True` </p>
</blockquote>
<h2 id="SaltStack与ZeroMQ"><a href="#SaltStack与ZeroMQ" class="headerlink" title="SaltStack与ZeroMQ"></a>SaltStack与ZeroMQ</h2><p> 我们进行自动化运维大多数情况下，是我们的服务器数量已经远远超过人工SSH维护的范围，SaltStack可以支数以千计，甚至更多的服务器。这些性能的提供主要来自于ZeroMQ，因为SaltStack底层是基于ZeroMQ进行高效的网络通信。ZMQ用于node与node间的通信，node可以是主机也可以是进程。</p>
<h3 id="ZeroMQ简介"><a href="#ZeroMQ简介" class="headerlink" title="ZeroMQ简介"></a>ZeroMQ简介</h3><p>  ZeroMQ（我们通常还会用ØMQ , 0MQ, zmq等来表示）是一个简单好用的传输层，像框架一样的一个套接字库，他使得Socket编程更加简单、简洁和性能更高。它还是一个消息处理队列库，可在多个线程、内核和主机盒之间弹性伸缩。<br>发布与订阅 ZeroMQ支持Publish/Subscribe，即发布与订阅模式，我们经常简称Pub/Sub。</p>
<p><img src="https://www.unixhot.com/uploads/article/20151027/055f24981e25860e08942d7f0aa9d0ab.png" alt=""></p>
<h5 id="发布与订阅模式（Publish-Subscribe）简称Pub-Sub"><a href="#发布与订阅模式（Publish-Subscribe）简称Pub-Sub" class="headerlink" title="发布与订阅模式（Publish/Subscribe）简称Pub/Sub"></a>发布与订阅模式（Publish/Subscribe）简称Pub/Sub</h5><p>所有的minion都会连到4505端口，而且是TCP的长连接</p>
<p>salt ‘*’ cmd.run ‘w’</p>
<h5 id="请求与响应模式"><a href="#请求与响应模式" class="headerlink" title="请求与响应模式"></a>请求与响应模式</h5><p>默认监听4506端口，返回结果的时候通过4506端口，</p>
<p>####### 显示进程标题</p>
<pre>
yum install -y python-setproctitle
systemctl restart salt-master
ps -ef|grep salt-mast
</pre>

<p><a href="https://www.unixhot.com/article/15" target="_blank" rel="external">相关文章介绍</a></p>
<h3 id="Saltstack的数据系统"><a href="#Saltstack的数据系统" class="headerlink" title="Saltstack的数据系统"></a>Saltstack的数据系统</h3><p><a href="http://www.cnblogs.com/alexyang8/p/3445333.html" target="_blank" rel="external">SaltStack整体架构</a><br>两种数据系统</p>
<p><em>　Grains（谷粒）
</em>　Pillar（柱子）</p>
<p>Grains是静态数据，它是在Minion启动的时候收集的Minion本地的相关信息，如：操作系统版本，内核版本，ＣＰＵ，内存，硬盘，设备型号，机器序列号。它可以做资产管理，只要不重启它，它就会只收集一次，当重启的时候才会再次收集，启动完后就不会变了,它是一个key/value的东西。</p>
<p>作用：</p>
<ul>
<li>资产管理、信息查询</li>
<li>用于目标选择（不同于ID的另外目标定义方法，操作系统等）</li>
<li>配置管理中使用</li>
</ul>
<h4 id="信息查询"><a href="#信息查询" class="headerlink" title="信息查询"></a>信息查询</h4><p>查看所有信息</p>
<pre>
salt 'linux-node1.example.com' grains.ls
salt 'linux-node1.example.com' grains.items
salt '*' grains.item os
salt '*' grains.item fqdn_ip4
</pre>

<h4 id="目标选择"><a href="#目标选择" class="headerlink" title="目标选择"></a>目标选择</h4><p>-G 参数</p>
<pre>
salt -G 'os:CentOS' test.ping
salt -G 'os:CentOS' cmd.run 'echo hehe'
</pre>

<p>可以给某一个minion自定义一个grains，然后再来找它，方法：写配置文件，有两种办法来存放 它</p>
<pre>
vim /etc/salt/minion
grains:
  roles: apache 
systemctl restart salt-minion
[root@linux-node1 salt]# salt '*' grains.item roles
linux-node2.example.com:
    ----------
    rolesode1.example.com:
    ----------
    roles:
[root@linux-node1 salt]# salt '*' grains.item roles
linux-node1.example.com:
    ----------
    roles:
linux-node2.example.com:
    ----------
    roles:
        apache:
</pre>

<p>重启所有apache</p>
<pre><code>salt -G &apos;roles:apache&apos; cmd.run &apos;systemctl restart httpd&apos;
</code></pre><blockquote>
<p>生产不建议放在minion配置文件里面，写在 <code>/etc/salt/grains</code> 里面，minion会自动来这找；并且上面这条命令中的roles:后面是没有空格的</p>
</blockquote>
<pre><code>cloud: openstack
salt &apos;*&apos; grains.item cloud
</code></pre><blockquote>
<p>加完之后必须重启，因为它是静态的。但不重启也有一个刷新的命令 <code>salt &#39;*&#39; saltutil.sync_grains</code> 无论上面两种方法写在哪都可以成功。</p>
</blockquote>
<h4 id="top-file使用案例"><a href="#top-file使用案例" class="headerlink" title="top file使用案例"></a>top file使用案例</h4><p>grains还可以用到top.sls文件里面</p>
<pre>
base:
  'linux-node1.example.com':
    - web.apache
  'roles:apache': 
    - match: grain 
    - web.apache
</pre>


<h4 id="配置管理的案例"><a href="#配置管理的案例" class="headerlink" title="配置管理的案例"></a>配置管理的案例</h4><p>vim /srv/salt/web/apache.sls</p>
<blockquote>
<p>可以自己用python脚本来写一个grains，实现动态，这里说的动态是通过逻辑后产生的</p>
</blockquote>
<h4 id="用Python开发一个grains"><a href="#用Python开发一个grains" class="headerlink" title="用Python开发一个grains"></a>用Python开发一个grains</h4><p>写一个python脚本返回一个字典就可以了。</p>
<ol>
<li>放哪儿<ol>
<li>cd /srv/salt/</li>
<li>mkdir _grains</li>
<li>cd _grains</li>
</ol>
</li>
<li>写脚本<ol>
<li>vim my_grains.py<br><pre><br>#!/usr/bin/env python<br>#-<em>- coding: utf-8 -</em>-</pre></li>
</ol>
</li>
</ol>
<p>def my_grains():</p>
<pre><code># 初始化一个grains字典
grains = {}
# 设置字典中的key/value
grains[&apos;iaas&apos;] = &apos;openstack&apos;
grains[&apos;edu&apos;] = &apos;example&apos;
# 返回这个字典
return grains
</code></pre><p></p>
<ol>
<li>把grains推送给minion<pre>
salt '*' saltutil.sync_grains
它会放在/var/cache/salt/minion/extmods/grains/my_grains.py
</pre></li>
<li>查看</li>
</ol>
<pre>
salt '*' grains.item iaas
</pre>

<p>Grains优先级：</p>
<ol>
<li>系统自带</li>
<li>grains文件写的</li>
<li>minion配置文件写的</li>
<li>自己写的</li>
</ol>
<h3 id="pillar"><a href="#pillar" class="headerlink" title="pillar"></a>pillar</h3><p>它也是数据系统，也是key/value，但是pillar数据是动态的，和minion启不启动没关系，它给特定的minion指定特定的数据，跟top file很像。只有指定的minion自己能看到自己的数据。</p>
<p>查看pillar</p>
<pre><code>salt &apos;*&apos; pillar.items
</code></pre><p>vim /etc/salt/master<br>646  注释去掉。改成True</p>
<p>systemctl restart salt-master</p>
<p>pillar_toots  topfile.sls</p>
<pre>
vim /etc/salt/master
642行
pillar_roots:
  base:
    - /srv/pillar

mkdir /srv/pillar
cd /srv/pillar
mkdir web
cd web
vim apache.sls

</pre>

<ol>
<li>写pillar的sls</li>
<li>写topfile(pillar必须要写topfile,不像配置管理不用也可以)</li>
</ol>
<pre>
salt '*' saltutil.refresh_pillar
salt '*' pillar.items apache
</pre>

<p>vim apache.sls<br>    hehe:<br>        </p>
<p>salt ‘<em>‘ saltutil.refresh_pillar<br>salt ‘</em>‘ pillar.items hehe</p>
<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><ol>
<li>目标选择<ol>
<li>salt -I ‘apache:httpd’ test.ping</li>
</ol>
</li>
</ol>
<p>这四种方式的匹配主要是为了在多机器环境下灵活地匹配主机</p>
<h3 id="Grains-VS-Pillar"><a href="#Grains-VS-Pillar" class="headerlink" title="Grains VS Pillar"></a>Grains VS Pillar</h3><p>Grains:        类型        数据采集方式                应用场景                        定义位置</p>
<p>Grains        静态        minion启动时收集        数据查询、目标选择、配置管理        minion端</p>
<p>Pillar        动态        master自定义            目标选择、配置管理、敏感数据存储    master端</p>
<h2 id="远程执行-1"><a href="#远程执行-1" class="headerlink" title="远程执行"></a>远程执行</h2><p>深入学习SaltStack远程执行</p>
<p>salt ‘*’ cmd.run ‘w’</p>
<p>命令：salt</p>
<p>目标： ‘*’（好多种方式指定）</p>
<p>模块：cmd.run   自带150+模块。可以自己写模块</p>
<p>返回：可以写入数据库里面，执行后结果返回，通过Returnners组件</p>
<h4 id="目标Targeting"><a href="#目标Targeting" class="headerlink" title="目标Targeting"></a>目标Targeting</h4><p>你要指定哪个或者哪些minion来执行后面的东西 ，怎么来定位？</p>
<p>两种定位的方法：</p>
<ol>
<li>和minion id有关的</li>
<li>和Minion_id无关的</li>
</ol>
<h5 id="有关的"><a href="#有关的" class="headerlink" title="有关的"></a>有关的</h5><ol>
<li>Minion id(linux-node1.example.com)</li>
<li>通配符(<em>/linux-node*</em>/linux-node[1|2].example.com/linux-node?.example.com)</li>
<li>列表：（salt -L ‘linux-node1.example.com,linux-node2.example.com’ test.ping）</li>
<li>正则表达式：（salt -E ‘linux-(node1|node2)*’ test.ping|salt -E ‘linux-(node1|node2).example.com’ test.ping）</li>
</ol>
<blockquote>
<p>所有匹配目标的方式都可以用在top file里面来指定目标 </p>
</blockquote>
<h5 id="无关的"><a href="#无关的" class="headerlink" title="无关的"></a>无关的</h5><p>主机名设置方案：</p>
<ol>
<li>IP地址</li>
<li>根据业务来进行设置</li>
</ol>
<pre>
redis-node1-redis03-idc03-soa.example.com
</pre>

<p>redis-node1  redis第一个节点</p>
<p>redis04   集群</p>
<p>idc04   机房</p>
<p>soa    业务线</p>
<p>子网和IP地址</p>
<pre>
salt -S 192.168.56.11 test.ping
salt -S 192.168.56.0/24 test.ping
</pre>

<h5 id="NODE-GROUPS"><a href="#NODE-GROUPS" class="headerlink" title="NODE GROUPS"></a>NODE GROUPS</h5><p>vim /etc/salt/master<br>/nodegroup</p>
<p>nodegroups:<br>  web: ‘L@linux-node1.example.com,linux-node2.example.com’<br>systemctl restart salt-master<br>salt -N web test.ping</p>
<h5 id="混合匹配"><a href="#混合匹配" class="headerlink" title="混合匹配"></a>混合匹配</h5><p><a href="https://www.unixhot.com/docs/saltstack/topics/targeting/compound.html" target="_blank" rel="external">https://www.unixhot.com/docs/saltstack/topics/targeting/compound.html</a></p>
<h5 id="批处理"><a href="#批处理" class="headerlink" title="批处理"></a>批处理</h5><p>可以通过百分比来执行</p>
<h4 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h4><p>saltstack内置了丰富的模块来执行,每一个模块都是一个python文件，挑几个来学习</p>
<h6 id="NETWORK"><a href="#NETWORK" class="headerlink" title="NETWORK"></a>NETWORK</h6><pre><code>salt &apos;*&apos; network.active_tcp
salt &apos;*&apos; network.arp
</code></pre><h6 id="SERVICE"><a href="#SERVICE" class="headerlink" title="SERVICE"></a>SERVICE</h6><pre><code>salt &apos;*&apos; service.available sshd
salt &apos;*&apos; service.get_all
</code></pre><h6 id="CP"><a href="#CP" class="headerlink" title="CP"></a>CP</h6><pre><code>salt-cp &apos;*&apos; /etc/hosts /tmp/hehe
</code></pre><h6 id="STATE"><a href="#STATE" class="headerlink" title="STATE"></a>STATE</h6><pre><code>salt &apos;*&apos; state.show_top
salt &apos;*&apos; state.single pkg.installed name=lsof
</code></pre><h3 id="返回程序"><a href="#返回程序" class="headerlink" title="返回程序"></a>返回程序</h3><p>把返回结果写到数据库里面</p>
<p>salt使用返回程序来实现这些功能(returnners)</p>
<h5 id="SALT-RETURNERS-MYSQL"><a href="#SALT-RETURNERS-MYSQL" class="headerlink" title="SALT.RETURNERS.MYSQL"></a>SALT.RETURNERS.MYSQL</h5><p>Returnn data to mysql server</p>
<p>这个返回数据是minion直接返回的，所有的minion要装python的MySQL 库</p>
<p>我们使用salt装</p>
<pre>
salt '*' state.single pkg.installed name=MySQL-python
yum install mariadb-server mariadb -y
systemctl start mariadb
</pre>

<pre>
mysql
CREATE DATABASE  `salt`
  DEFAULT CHARACTER SET utf8
  DEFAULT COLLATE utf8_general_ci;
USE `salt`;
CREATE TABLE `jids` (
  `jid` varchar(255) NOT NULL,
  `load` mediumtext NOT NULL,
  UNIQUE KEY `jid` (`jid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
CREATE INDEX jid ON jids(jid) USING BTREE;
CREATE TABLE `salt_returns` (
  `fun` varchar(50) NOT NULL,
  `jid` varchar(255) NOT NULL,
  `return` mediumtext NOT NULL,
  `id` varchar(255) NOT NULL,
  `success` varchar(10) NOT NULL,
  `full_ret` mediumtext NOT NULL,
  `alter_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  KEY `id` (`id`),
  KEY `jid` (`jid`),
  KEY `fun` (`fun`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
CREATE TABLE `salt_events` (
`id` BIGINT NOT NULL AUTO_INCREMENT,
`tag` varchar(255) NOT NULL,
`data` mediumtext NOT NULL,
`alter_time` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
`master_id` varchar(255) NOT NULL,
PRIMARY KEY (`id`),
KEY `tag` (`tag`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
grant all on salt.* to salt@'%' identified by 'salt@pw';
flush privileges;
mysql -h 192.168.56.11 -usalt -psalt@pw
</pre>

<p>修改minion配置文件</p>
<pre>
vim /etc/salt/minion
mysql.host: '192.168.56.11'
mysql.user: 'salt'
mysql.pass: 'salt@pw'
mysql.db: 'salt'
mysql.port: 3306
systemctl restart salt-minion
</pre>

<p>执行结果：</p>
<pre>
[root@linux-node1 salt]# salt '*' test.ping --return mysql
linux-node2.example.com:
    True
linux-node1.example.com:
    True
[root@linux-node1 salt]# mysql
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 8
Server version: 5.5.47-MariaDB MariaDB Server

Copyright (c) 2000, 2015, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]> use salt;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MariaDB [salt]> show tables;
+----------------+
| Tables_in_salt |
+----------------+
| jids           |
| salt_events    |
| salt_returns   |
+----------------+
3 rows in set (0.00 sec)

MariaDB [salt]> select * from salt_returns;
+-----------+----------------------+--------+---------------------------+---------+-------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+
| fun       | jid                  | return | id                        | success | full_ret                                                                                                                                              | alter_time          |
+-----------+----------------------+--------+---------------------------+---------+-------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+
| test.ping | 20160626025439671711 | true   | linux-node2.example.com | 1       | {"fun_args": [], "jid": "20160626025439671711", "return": true, "retcode": 0, "success": true, "fun": "test.ping", "id": "linux-node2.example.com"} | 2016-06-26 02:54:39 |
| test.ping | 20160626025439671711 | true   | linux-node1.example.com | 1       | {"fun_args": [], "jid": "20160626025439671711", "return": true, "retcode": 0, "success": true, "fun": "test.ping", "id": "linux-node1.example.com"} | 2016-06-26 02:54:39 |
+-----------+----------------------+--------+---------------------------+---------+-------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------+
2 rows in set (0.00 sec)
</pre>

<h3 id="编写一个执行模块"><a href="#编写一个执行模块" class="headerlink" title="编写一个执行模块"></a>编写一个执行模块</h3><p>vim /usr/lib/python2.7/site-packages/salt/modules/service.py</p>
<p>编写模块：</p>
<ol>
<li>放哪（cd /srv/salt/_modules）</li>
<li>命名（文件名就是模块名，如my_disk.py）<br><pre><br>[root@linux-node1 _modules]# cat my_disk.py<br>#!/usr/bin/env python</pre></li>
</ol>
<p>def list():<br>  cmd = ‘df -h’<br>  ret = <strong>salt</strong><a href="cmd">‘cmd.run’</a><br>  return ret<br></p>
<p>刷新</p>
<pre><code>salt &apos;*&apos; saltutil.sync_modules
</code></pre><pre>
[root@linux-node2 ~]# tree /var/cache/salt/minion/
/var/cache/salt/minion/
├── accumulator
├── extmods
│   ├── grains
│   │   ├── my_grains.py
│   │   └── my_grains.pyc
│   └── modules
│       └── my_disk.py
├── files
│   └── base
│       ├── _grains
│       │   └── my_grains.py
│       ├── _modules
│       │   └── my_disk.py
│       ├── top.sls
│       └── web
│           └── apache.sls
├── highstate.cache.p
├── module_refresh
├── pkg_refresh
├── proc
└── sls.p

[root@linux-node1 _modules]# salt '*' my_disk.list
linux-node2.example.com:
    Filesystem      Size  Used Avail Use% Mounted on
    /dev/sda3       196G  2.1G  194G   2% /
    devtmpfs        480M     0  480M   0% /dev
    tmpfs           489M   12K  489M   1% /dev/shm
    tmpfs           489M  6.7M  483M   2% /run
    tmpfs           489M     0  489M   0% /sys/fs/cgroup
    /dev/sda1       497M  128M  370M  26% /boot
    tmpfs            98M     0   98M   0% /run/user/0
linux-node1.example.com:
    Filesystem      Size  Used Avail Use% Mounted on
    /dev/sda3       196G  2.3G  194G   2% /
    devtmpfs        480M     0  480M   0% /dev
    tmpfs           489M   40K  489M   1% /dev/shm
    tmpfs           489M  6.8M  483M   2% /run
    tmpfs           489M     0  489M   0% /sys/fs/cgroup
    /dev/sda1       497M  128M  370M  26% /boot
    tmpfs            98M     0   98M   0% /run/user/0
</pre>


<div style="box-shadw:0px 0px 3px #000;" markdown="1"><br>        <img src="https://github.com/Aresona/edu-docs/blob/master/image/touxiang.jpg"><br></div>


<p>作业<br>预习配置管理</p>
<p><a href="https://github.com/unixhot" target="_blank" rel="external">https://github.com/unixhot</a></p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/06/22/zabbix2/" rel="next" title="zabbix2">
                <i class="fa fa-chevron-left"></i> zabbix2
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://github.com/Aresona/edu-docs/blob/master/image/%E5%A4%B4%E5%83%8F.jpg"
               alt="John Doe" />
          <p class="site-author-name" itemprop="name">John Doe</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">3</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#运维自动化之SaltStack"><span class="nav-number">1.</span> <span class="nav-text">运维自动化之SaltStack</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.1.</span> <span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SaltStack-三大功能："><span class="nav-number">1.1.1.</span> <span class="nav-text">SaltStack 三大功能：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SaltStack-四种运行方式"><span class="nav-number">1.1.2.</span> <span class="nav-text">SaltStack 四种运行方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#典型案例"><span class="nav-number">1.1.3.</span> <span class="nav-text">典型案例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#QUICK-START"><span class="nav-number">1.2.</span> <span class="nav-text">QUICK START</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">1.2.1.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Master端"><span class="nav-number">1.2.1.0.0.1.</span> <span class="nav-text">Master端</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Minion端"><span class="nav-number">1.2.1.0.0.2.</span> <span class="nav-text">Minion端</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#windows下Minion安装"><span class="nav-number">1.2.1.0.0.3.</span> <span class="nav-text">windows下Minion安装</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置及启动"><span class="nav-number">1.2.2.</span> <span class="nav-text">配置及启动</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#启动salt-master"><span class="nav-number">1.2.2.0.0.1.</span> <span class="nav-text">启动salt-master</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#配置并启动minion"><span class="nav-number">1.2.2.0.0.2.</span> <span class="nav-text">配置并启动minion</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#认证"><span class="nav-number">1.2.3.</span> <span class="nav-text">认证</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#列出所有keys"><span class="nav-number">1.2.3.0.0.1.</span> <span class="nav-text">列出所有keys</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ID的设置"><span class="nav-number">1.2.4.</span> <span class="nav-text">ID的设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#远程执行"><span class="nav-number">1.2.5.</span> <span class="nav-text">远程执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#salt命令用法"><span class="nav-number">1.2.6.</span> <span class="nav-text">salt命令用法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置管理"><span class="nav-number">1.2.7.</span> <span class="nav-text">配置管理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#理解YAML"><span class="nav-number">1.2.7.0.1.</span> <span class="nav-text">理解YAML</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#三个规则"><span class="nav-number">1.2.7.0.1.1.</span> <span class="nav-text">三个规则</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#写一个状态文件"><span class="nav-number">1.2.7.1.</span> <span class="nav-text">写一个状态文件</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#遇到的错误"><span class="nav-number">1.2.7.1.0.1.</span> <span class="nav-text">遇到的错误</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#执行小技巧"><span class="nav-number">1.2.7.1.0.2.</span> <span class="nav-text">执行小技巧</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过-top-sls来有选择地执行状态文件"><span class="nav-number">1.2.7.2.</span> <span class="nav-text">通过 top.sls来有选择地执行状态文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#执行高级状态"><span class="nav-number">1.2.7.2.1.</span> <span class="nav-text">执行高级状态</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SaltStack与ZeroMQ"><span class="nav-number">1.3.</span> <span class="nav-text">SaltStack与ZeroMQ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ZeroMQ简介"><span class="nav-number">1.3.1.</span> <span class="nav-text">ZeroMQ简介</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#发布与订阅模式（Publish-Subscribe）简称Pub-Sub"><span class="nav-number">1.3.1.0.1.</span> <span class="nav-text">发布与订阅模式（Publish/Subscribe）简称Pub/Sub</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#请求与响应模式"><span class="nav-number">1.3.1.0.2.</span> <span class="nav-text">请求与响应模式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Saltstack的数据系统"><span class="nav-number">1.3.2.</span> <span class="nav-text">Saltstack的数据系统</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#信息查询"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">信息查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#目标选择"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">目标选择</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#top-file使用案例"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">top file使用案例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置管理的案例"><span class="nav-number">1.3.2.4.</span> <span class="nav-text">配置管理的案例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#用Python开发一个grains"><span class="nav-number">1.3.2.5.</span> <span class="nav-text">用Python开发一个grains</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pillar"><span class="nav-number">1.3.3.</span> <span class="nav-text">pillar</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#使用场景"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">使用场景</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Grains-VS-Pillar"><span class="nav-number">1.3.4.</span> <span class="nav-text">Grains VS Pillar</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#远程执行-1"><span class="nav-number">1.4.</span> <span class="nav-text">远程执行</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#目标Targeting"><span class="nav-number">1.4.0.1.</span> <span class="nav-text">目标Targeting</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#有关的"><span class="nav-number">1.4.0.1.1.</span> <span class="nav-text">有关的</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#无关的"><span class="nav-number">1.4.0.1.2.</span> <span class="nav-text">无关的</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#NODE-GROUPS"><span class="nav-number">1.4.0.1.3.</span> <span class="nav-text">NODE GROUPS</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#混合匹配"><span class="nav-number">1.4.0.1.4.</span> <span class="nav-text">混合匹配</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#批处理"><span class="nav-number">1.4.0.1.5.</span> <span class="nav-text">批处理</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#模块"><span class="nav-number">1.4.0.2.</span> <span class="nav-text">模块</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#NETWORK"><span class="nav-number">1.4.0.2.0.1.</span> <span class="nav-text">NETWORK</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#SERVICE"><span class="nav-number">1.4.0.2.0.2.</span> <span class="nav-text">SERVICE</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#CP"><span class="nav-number">1.4.0.2.0.3.</span> <span class="nav-text">CP</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#STATE"><span class="nav-number">1.4.0.2.0.4.</span> <span class="nav-text">STATE</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#返回程序"><span class="nav-number">1.4.1.</span> <span class="nav-text">返回程序</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SALT-RETURNERS-MYSQL"><span class="nav-number">1.4.1.0.1.</span> <span class="nav-text">SALT.RETURNERS.MYSQL</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写一个执行模块"><span class="nav-number">1.4.2.</span> <span class="nav-text">编写一个执行模块</span></a></li></ol></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  
  

  

  

</body>
</html>
